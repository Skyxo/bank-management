<!DOCTYPE html>
<html>
<head>
    <title>Dashboard Bancaire</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--primary);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-size: 24px;
            font-weight: 600;
        }
        
        h2 {
            color: var(--primary);
            font-size: 20px;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .stat-title {
            font-size: 14px;
            color: #777;
            margin-bottom: 8px;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 8px;
        }
        
        .stat-value.positive {
            color: var(--success);
        }
        
        .stat-value.negative {
            color: var(--danger);
        }
        
        .stat-subtitle {
            font-size: 13px;
            color: #999;
        }
        
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .chart-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            min-height: 300px;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th {
            background-color: var(--light);
            color: var(--dark);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }
        
        tr:hover {
            background-color: #f9f9f9;
        }
        
        .positive {
            color: var(--success);
        }
        
        .negative {
            color: var(--danger);
        }
        
        .actions {
            margin: 20px 0;
            display: flex;
            gap: 15px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--secondary);
            color: white;
            text-decoration: none;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success);
        }
        
        .btn-success:hover {
            background-color: #219653;
        }
        
        .monthly-stats {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .month-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 200px;
        }
        
        .month-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: var(--dark);
            font-size: 14px;
        }
        
        .month-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 13px;
        }
        
        .month-label {
            color: #777;
        }
        
        .month-value {
            font-weight: bold;
            text-align: right;
        }
        
        @media (max-width: 768px) {
            .stats-container {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                grid-template-columns: 1fr;
            }
            
            .month-card {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>Dashboard Bancaire</h1>
            <div class="actions">
                <a href="/download" class="btn">Télécharger CSV</a>
            </div>
        </div>
    </header>
    
    <div class="container">
        {% if stats %}
        <section>
            <h2>Aperçu Financier</h2>
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-title">Solde actuel</div>
                    <div class="stat-value {% if stats.solde > 0 %}positive{% elif stats.solde < 0 %}negative{% endif %}">
                        {{ stats.solde|round(2) }} €
                    </div>
                    <div class="stat-subtitle">Tous comptes confondus</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Revenus</div>
                    <div class="stat-value positive">{{ stats.total_revenus|round(2) }} €</div>
                    <div class="stat-subtitle">Total des entrées d'argent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Dépenses</div>
                    <div class="stat-value negative">{{ stats.total_depenses|round(2) }} €</div>
                    <div class="stat-subtitle">Total des sorties d'argent</div>
                </div>
                <div class="stat-card">
                    <div class="stat-title">Transactions</div>
                    <div class="stat-value">{{ transactions|length }}</div>
                    <div class="stat-subtitle">Nombre total de transactions</div>
                </div>
            </div>
        </section>

        <!-- Contrôles d'affichage -->
        <section class="actions" style="flex-wrap: wrap; align-items: center; gap: 10px;">
            <div>
                <label for="interestFilter">Centre d'intérêt:</label>
                <select id="interestFilter">
                    <option value="__all__">Tout</option>
                </select>
            </div>
            <div>
                <label for="startDate">De:</label>
                <input id="startDate" type="date" />
            </div>
            <div>
                <label for="endDate">À:</label>
                <input id="endDate" type="date" />
            </div>
            <button id="resetZoomBtn" class="btn" type="button">Réinitialiser le zoom</button>
        </section>

        <section class="chart-container">
            <div class="chart-card">
                <h2>Dépenses quotidiennes</h2>
                <canvas id="expensesChart"></canvas>
            </div>
            <div class="chart-card">
                <h2>Solde cumulé</h2>
                <canvas id="balanceChart"></canvas>
            </div>
            <div class="chart-card" style="grid-column: 1 / -1;">
                <h2>Dépenses par centres d'intérêt</h2>
                <canvas id="interestChart"></canvas>
            </div>
            <div class="chart-card" style="grid-column: 1 / -1;">
                <h2>Répartition des dépenses</h2>
                <canvas id="pieExpensesChart"></canvas>
                <div id="pieEmpty" style="display:none;color:#777;margin-top:8px;">Aucune dépense à afficher pour la période</div>
            </div>
        </section>
        
        {% if stats.par_mois %}
        <section>
            <h2>Évolution Mensuelle</h2>
            <div class="monthly-stats">
                {% for mois, data in stats.par_mois.items() %}
                <div class="month-card">
                    <div class="month-title">{{ mois }}</div>
                    <div class="month-data">
                        <div class="month-label">Transactions:</div>
                        <div class="month-value">{{ data.nb_transactions }}</div>
                        
                        <div class="month-label">Revenus:</div>
                        <div class="month-value positive">{{ data.revenus|round(2) }} €</div>
                        
                        <div class="month-label">Dépenses:</div>
                        <div class="month-value negative">{{ data.depenses|round(2) }} €</div>
                        
                        <div class="month-label">Solde:</div>
                        <div class="month-value {% if data.total > 0 %}positive{% elif data.total < 0 %}negative{% endif %}">{{ data.total|round(2) }} €</div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}
        {% endif %}
        
        <section class="table-container">
            <h2>Détail des Transactions</h2>
            <table>
                <thead>
                    <tr>
                        {% for column in columns %}
                        {% if column in ['id', 'id_account', 'account_id'] %}
                        {% else %}
                        <th>{{ column|replace('_', ' ')|capitalize }}</th>
                        {% endif %}
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for _, row in transactions.iterrows() %}
                    <tr>
                        {% for column in columns %}
                        {% if column in ['id', 'id_account', 'account_id'] %}
                        {% else %}
                        <td{% if column in ['amount', 'value'] and row[column] < 0 %} class="negative"{% elif column in ['amount', 'value'] and row[column] > 0 %} class="positive"{% endif %}>
                            {% if column == 'date' %}
                                {{ row[column]|string|truncate(10, True, '') }}
                            {% elif column in ['amount', 'value', 'original_value'] and row[column] is not none %}
                                {{ row[column]|round(2) }} €
                            {% else %}
                                {{ row[column] }}
                            {% endif %}
                        </td>
                        {% endif %}
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>
    </div>
 
    <!-- Chart.js CDN -->
    <!-- Données graphiques au format JSON pour éviter l'injection directe dans JS -->
    <script id="chart-data" type="application/json">{{ chart_data|tojson }}</script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2"></script>
    <script>
        const chartData = JSON.parse(document.getElementById('chart-data').textContent);
        const euroFmt = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'EUR' });
        // Enregistrement du plugin de zoom/pan
        if (window.ChartZoom) { Chart.register(window.ChartZoom); }
        else if (window['chartjs-plugin-zoom']) { Chart.register(window['chartjs-plugin-zoom']); }
 
        let expensesChart, balanceChart, interestChart, pieChart;
 
        function filterByDate(labels, values, from, to) {
            if (!labels || !values) return { labels, values };
            const fromTime = from ? new Date(from).getTime() : null;
            const toTime = to ? new Date(to).getTime() : null;
            const outLabels = [];
            const outValues = [];
            for (let i = 0; i < labels.length; i++) {
                const t = new Date(labels[i]).getTime();
                if ((fromTime === null || t >= fromTime) && (toTime === null || t <= toTime)) {
                    outLabels.push(labels[i]);
                    outValues.push(values[i]);
                }
            }
            return { labels: outLabels, values: outValues };
        }

        function getDateRangeFromData() {
            const candidatesList = [
                (chartData && chartData.balance && chartData.balance.labels) ? chartData.balance.labels : null,
                (chartData && chartData.expenses && chartData.expenses.labels) ? chartData.expenses.labels : null,
                (chartData && chartData.by_interest && chartData.by_interest.labels) ? chartData.by_interest.labels : null
            ];
            const candidates = candidatesList.find(function(arr){ return Array.isArray(arr) && arr.length > 0; });
            if (!candidates) return { min: null, max: null };
            return { min: candidates[0], max: candidates[candidates.length - 1] };
        }
 
        function makeExpensesChart(from = null, to = null) {
            if (!chartData || !chartData.expenses) return;
            const ctx = document.getElementById('expensesChart');
            const filtered = filterByDate(chartData.expenses.labels, chartData.expenses.values, from, to);
            expensesChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: filtered.labels,
                    datasets: [{
                        label: 'Dépenses (€/jour)',
                        data: filtered.values,
                        backgroundColor: 'rgba(231, 76, 60, 0.4)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        tooltip: { callbacks: { label: (ctx) => euroFmt.format(ctx.parsed.y) } },
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function makeBalanceChart(from = null, to = null) {
            if (!chartData || !chartData.balance) return;
            const ctx = document.getElementById('balanceChart');
            const filtered = filterByDate(chartData.balance.labels, chartData.balance.values, from, to);
            balanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filtered.labels,
                    datasets: [{
                        label: 'Solde cumulé (EUR)',
                        data: filtered.values,
                        borderColor: 'rgba(52, 152, 219, 1)',
                        backgroundColor: 'rgba(52, 152, 219, 0.2)',
                        tension: 0.2,
                        fill: true
                    }]
                },
                options: {
                    plugins: {
                        tooltip: { callbacks: { label: (ctx) => euroFmt.format(ctx.parsed.y) } },
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                        }
                    }
                }
            });
        }

        function makeInterestChart(category = '__all__', from = null, to = null) {
            if (!chartData || !chartData.by_interest) return;
            const ctx = document.getElementById('interestChart');
            const datasets = chartData.by_interest.datasets
                .filter(ds => category === '__all__' || ds.label === category)
                .map(ds => {
                    const filtered = filterByDate(chartData.by_interest.labels, ds.values, from, to);
                    return {
                        label: ds.label,
                        data: filtered.values,
                        borderColor: ds.borderColor,
                        backgroundColor: ds.backgroundColor,
                        tension: 0.2,
                        fill: false
                    };
                });
            const filteredLabels = filterByDate(chartData.by_interest.labels, chartData.by_interest.labels.map(() => 0), from, to).labels;
            interestChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: filteredLabels,
                    datasets: datasets
                },
                options: {
                    plugins: {
                        tooltip: { callbacks: { label: (ctx) => euroFmt.format(ctx.parsed.y) } },
                        legend: { position: 'bottom' },
                        zoom: {
                            pan: { enabled: true, mode: 'x' },
                            zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        }

        function makeExpensesPie(from = null, to = null) {
            if (!chartData || !chartData.by_interest || !Array.isArray(chartData.by_interest.datasets)) return;
            const canvas = document.getElementById('pieExpensesChart');
            const ctx = canvas.getContext('2d');

            // Calculer le total des dépenses par centre (sur la période)
            const labels = [];
            const data = [];
            const colors = [];
            chartData.by_interest.datasets.forEach(function(ds){
                const filtered = filterByDate(chartData.by_interest.labels, ds.values, from, to);
                const total = filtered.values.reduce(function(acc, v){
                    const num = Number(v) || 0; return acc + (num < 0 ? -num : num);
                }, 0);
                if (total > 0) {
                    labels.push(ds.label);
                    data.push(total);
                    colors.push(ds.backgroundColor || 'rgba(52, 152, 219, 0.5)');
                }
            });

            if (pieChart) { try { pieChart.destroy(); } catch(e){} }
            if (data.length === 0) {
                document.getElementById('pieEmpty').style.display = 'block';
                return;
            } else {
                document.getElementById('pieEmpty').style.display = 'none';
            }

            pieChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderWidth: 1
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'right' },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${euroFmt.format(ctx.parsed)} (${(ctx.parsed / data.reduce((a,b)=>a+b,0) * 100).toFixed(1)}%)` } }
                    }
                }
            });
        }

        // Peupler la liste des centres d'intérêt
        (function initControls(){
            const sel = document.getElementById('interestFilter');
            const centers = (chartData && chartData.by_interest && Array.isArray(chartData.by_interest.datasets))
                ? chartData.by_interest.datasets.map(function(ds){ return ds.label; })
                : [];
            centers.forEach(function(c){
                const opt = document.createElement('option');
                opt.value = c; opt.textContent = c;
                sel.appendChild(opt);
            });
            const range = getDateRangeFromData();
            const sd = document.getElementById('startDate');
            const ed = document.getElementById('endDate');
            if (range.min) { sd.min = range.min; sd.value = range.min; }
            if (range.max) { ed.max = range.max; ed.value = range.max; }
        })();

        function redrawAll() {
            const sel = document.getElementById('interestFilter');
            const sd = document.getElementById('startDate');
            const ed = document.getElementById('endDate');
            const category = sel.value || '__all__';
            const from = sd.value || null;
            const to = ed.value || null;
            if (expensesChart) expensesChart.destroy();
            if (balanceChart) balanceChart.destroy();
            if (interestChart) interestChart.destroy();
            if (pieChart) pieChart.destroy();
            makeExpensesChart(from, to);
            makeBalanceChart(from, to);
            makeInterestChart(category, from, to);
            makeExpensesPie(from, to);
        }

        document.getElementById('interestFilter').addEventListener('change', redrawAll);
        document.getElementById('startDate').addEventListener('change', redrawAll);
        document.getElementById('endDate').addEventListener('change', redrawAll);
        document.getElementById('resetZoomBtn').addEventListener('click', () => {
            [expensesChart, balanceChart, interestChart].forEach(c => c && c.resetZoom && c.resetZoom());
        });

        // Initial draw
        redrawAll();
    </script>
</body>
</html>